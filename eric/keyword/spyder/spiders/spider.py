# -*- coding: utf-8 -*-
from urllib.parse import urlparse
from scrapy.spiders import CrawlSpider, Rule
from scrapy.linkextractors import LinkExtractor

def find_nth(haystack, needle, n):
    start = haystack.find(needle)
    while start >= 0 and n > 1:
        start = haystack.find(needle, start+len(needle))
        n -= 1
    return start

class keywordSpyder(CrawlSpider):
	name = "spyder" #Spider name
	rules = [Rule(LinkExtractor(deny=('/pdf/', '/PDF/')), callback='parse_item', follow=True),] # Follow any link scrapy finds (that is allowed).
	allowed_domains = ["nationalsteak.com", "bamasea.com", "organicmilling.com", "unitedsalad.com", "miceli-dairy.com", "seabrookfarms.com", "krugerfoods.com", "brucepac.com", "lentzmilling.com", "goldenvalleynatural.com", "crescenthalal.com", "crunchpak.com", "danielswesternmeatpackers.com", "auroraorganic.com", "cento.com", "marcangelofoods.com", "premiermeats.com", "seaclam.com", "greatrangebison.com", "eatbbqribs.com", "bestprovision.com", "atkfoods.com", "lacrossemilling.com", "kreiderfarms.com", "uniteddairy.com", "maverickranchmeats.com", "kiolbassa.com", "smartchicken.com", "epicurean-foods.com", "chicagomeat.com", "mandafinemeats.com", "baloianfarms.com", "kqf.com", "themushroomcompany.com", "josephfarms.com", "vegfresh.com", "GNSfoods.com", "creminelli.com", "alexanderhornung.com", "rogerwoodfoods.com", "wellpict.com", "beefinternational.com", "beasbest.com", "cfpacking.com", "mooneyfarms.com", "hughsonnut.com", "gerbers.com", "kunzler.com", "brightharvest.com", "atlanticveal.com", "partnersproduceinc.com", "aquastar.com", "lafittefrozenfoods.com", "bluestarfoods.com", "zmeats.com", "didionmilling.com", "strube.com", "columbiapacking.com", "mccartneyproduce.com", "stavis.com", "rshanline.com", "sunrisefarm.net", "foxy.com", "stevens-sausage.com", "vinyardinc.com", "sabatinotruffles.com", "jacobsfarm.com", "cloverpetaluma.com", "hausmanfoods.com", "tiptoppoultry.com", "duttandwagner.com", "carmelitachorizo.com", "sadlerssmokehouse.com", "kingscommand.com", "californiacereal.com", "antoniomozzarella.com", "berksfoods.com", "koegelmeats.com", "tastyduck.com", "kustompakfoods.com", "straussveal.com", "rcprovision.com", "ellenbee.com", "klondikecheese.com", "msmilling.com", "oldneighborhoodfoods.com", "applesnax.com", "pafco.net", "oregonpotato.com", "jbfoods.com", "auroraproduct.com", "producersdairy.com", "lincolnprovision.com", "rsmexfoods.com", "bubba-burger.com", "hunterfoods.com", "harringtonham.com", "devaultfoods.com", "frickmeats.com", "brakebush.com", "ore-cal.com", "wontonfood.com", "wisconcorp.com", "charliespride.com, www.bar-m.com", "durhams.com", "rizolopezfoods.com", "kayem.com", "kowality.com", "dllee.com", "vgiordano.com", "harvestselect.com", "hodgsonmill.com", "lionraisins.com", "osteenmeats.com", "handycrab.com", "pearsonfoods.com", "itsgooo-od.com", "volpifoods.com", "euclidfish.com", "ruggieroseafood.com", "chermakeprivatelabel.com", "godshalls.com", "sweetenersupply.com", "daviscreekmeat.com", "gulfpac.com", "cardinalmeats.com", "royalridgefruits.com", "nutrical.com.mx", "terrilynn.com", "santinifoods.com", "superiornutandcandy.com", "easternfisheries.com", "nueskes.com", "crownprince.com", "hearnkirkwood.com", "straussbrands.com", "acmesmokedfish.com", "cypressgrovechevre.com", "intldelicacies.com", "downsfoodgroup.com", "peerfoods.com", "belmontsausage.com", "hollypoultry.com", "andeannaturals.com", "viennabeef.com", "marcusfoodco.com", "selectonion.com", "aycofarms.com", "bassianfarms.com", "countryfreshinc.com", "qppinc.net", "harrisonspoultryfarm.com", "jonesdairyfarm.com", "bobak.com", "schaferfish.com", "tropicalfoods.com", "holmesfoods.com", "deenmeat.com", "oberto.com", "cibaomeat.com", "sewfriel.com", "babefarms.com", "comeausea.com", "doleandbailey.com", "casings.com", "mctdairies.com", "bsm.com", "sunriseproduce.com", "marchofarms.com", "berginfruit.com", "porkchops.com", "newstarfresh.com", "neesesausage.com", "sjsusa.com", "cappolafood.com", "daybreakfoods.com", "rosepacking.com", "belgioioso.com", "mullinscheese.com", "snopac.com", "sunvalleypecan.com", "progressiveproduce.com", "rembrandtfoods.com", "bcfoods.com", "kingnut.com", "dairyfoodusa.com", "randallfoods.com", "sunridgefarms.com", "goodheart.com", "northernproducts.com", "burnhamandmills.com", "marderbrands.com", "engelhartgourmet.com", "bazzininuts.com", "tulkoff.com", "curtispacking.com", "rumianocheese.com", "astrafoods.com", "blasersusa.com", "laurasleanbeef.com", "steubenfoods.com", "neiljonesfoodcompany.com", "sunnymorning.com", "bornstein.com", "mapleleaffarms.com", "catfish.net", "sbolive.com", "independentmeat.com", "suzannaskitchen.com", "routhpacking.com", "webstercitycustommeats.com", "cambridgepacking.com", "dartagnan.com", "agridairy.com", "isa-ak.com", "sunnyvalleysmokedmeats.com", "superiorfoods.com", "williams-sausage.com", "ingomarpacking.com", "thompack.com", "countrypleasin.com", "christopherranch.com", "fruit-dor.ca", "winonafoods.com", "fruvemex.com", "pintys.com", "bcwilliams.com", "southmill.com", "wilcoxfarms.com", "instantwhip.com", "cloverdalefoods.com", "dearbornbrand.com", "creamoland.com", "lcfoods.com", "superiorfoods.co", "danielefoods.com", "wawona.com", "livegourmet.com", "aedairy.com", "chefsrequested.com", "frontiermeats.com", "twincityfoods.com", "premiofoods.com", "turnerdairy.net", "clofinedairy.com", "moodydunbar.com", "radlo.com", "bothwellcheese.com", "holmessmokehouse.com", "cibaria-intl.com", "proportionfoods.com", "idahomilkproducts.com"]
	start_urls = ["http://www.nationalsteak.com", "http://www.bamasea.com", "http://www.organicmilling.com", "http://www.unitedsalad.com", "http://www.miceli-dairy.com", "http://www.seabrookfarms.com", "http://www.krugerfoods.com", "http://www.brucepac.com", "http://www.lentzmilling.com", "http://www.goldenvalleynatural.com", "http://www.crescenthalal.com", "http://www.crunchpak.com", "http://www.danielswesternmeatpackers.com", "http://www.auroraorganic.com", "http://www.cento.com", "http://www.marcangelofoods.com", "http://www.premiermeats.com", "http://www.seaclam.com", "http://www.greatrangebison.com", "http://www.eatbbqribs.com", "http://www.bestprovision.com", "http://www.atkfoods.com", "http://www.lacrossemilling.com", "http://www.kreiderfarms.com", "http://www.uniteddairy.com", "http://www.maverickranchmeats.com", "http://www.kiolbassa.com", "http://www.smartchicken.com", "http://www.epicurean-foods.com", "http://www.chicagomeat.com", "http://www.mandafinemeats.com", "http://www.baloianfarms.com", "http://www.kqf.com", "http://www.themushroomcompany.com", "http://www.josephfarms.com", "http://www.vegfresh.com", "http://www.GNSfoods.com", "http://www.creminelli.com", "http://www.alexanderhornung.com", "http://www.rogerwoodfoods.com", "http://www.wellpict.com", "http://www.beefinternational.com", "http://www.beasbest.com", "http://www.cfpacking.com", "http://www.mooneyfarms.com", "http://www.hughsonnut.com", "http://www.gerbers.com", "http://www.kunzler.com", "http://www.brightharvest.com", "http://www.atlanticveal.com", "http://www.partnersproduceinc.com", "http://www.aquastar.com", "http://www.lafittefrozenfoods.com", "http://www.bluestarfoods.com", "http://www.zmeats.com", "http://www.didionmilling.com", "http://www.strube.com", "http://www.columbiapacking.com", "http://www.mccartneyproduce.com", "http://www.stavis.com", "http://www.rshanline.com", "http://www.sunrisefarm.net", "http://www.foxy.com", "http://www.stevens-sausage.com", "http://www.vinyardinc.com", "http://www.sabatinotruffles.com", "http://www.jacobsfarm.com", "http://www.cloverpetaluma.com", "http://www.hausmanfoods.com", "http://www.tiptoppoultry.com", "http://www.duttandwagner.com", "http://www.carmelitachorizo.com", "http://www.sadlerssmokehouse.com", "http://www.kingscommand.com", "http://www.californiacereal.com", "http://www.antoniomozzarella.com", "http://www.berksfoods.com", "http://www.koegelmeats.com", "http://www.tastyduck.com", "http://www.kustompakfoods.com", "http://www.straussveal.com", "http://www.rcprovision.com", "http://www.ellenbee.com", "http://www.klondikecheese.com", "http://www.msmilling.com", "http://www.oldneighborhoodfoods.com", "http://www.applesnax.com", "http://www.pafco.net", "http://www.oregonpotato.com", "http://www.jbfoods.com", "http://www.auroraproduct.com", "http://www.producersdairy.com", "http://www.lincolnprovision.com", "http://www.rsmexfoods.com", "http://www.bubba-burger.com", "http://www.hunterfoods.com", "http://www.harringtonham.com", "http://www.devaultfoods.com", "http://www.frickmeats.com", "http://www.brakebush.com", "http://www.ore-cal.com", "http://www.wontonfood.com", "http://www.wisconcorp.com", "http://www.charliespride.com, www.bar-m.com", "http://www.durhams.com", "http://www.rizolopezfoods.com", "http://www.kayem.com", "http://www.kowality.com", "http://www.dllee.com", "http://www.vgiordano.com", "http://www.harvestselect.com", "http://www.hodgsonmill.com", "http://www.lionraisins.com", "http://www.osteenmeats.com", "http://www.handycrab.com", "http://www.pearsonfoods.com", "http://www.itsgooo-od.com", "http://www.volpifoods.com", "http://www.euclidfish.com", "http://www.ruggieroseafood.com", "http://www.chermakeprivatelabel.com", "http://www.godshalls.com", "http://www.sweetenersupply.com", "http://www.daviscreekmeat.com", "http://www.gulfpac.com", "http://www.cardinalmeats.com", "http://www.royalridgefruits.com", "http://www.nutrical.com.mx", "http://www.terrilynn.com", "http://www.santinifoods.com", "http://www.superiornutandcandy.com", "http://www.easternfisheries.com", "http://www.nueskes.com", "http://www.crownprince.com", "http://www.hearnkirkwood.com", "http://www.straussbrands.com", "http://www.acmesmokedfish.com", "http://www.cypressgrovechevre.com", "http://www.intldelicacies.com", "http://www.downsfoodgroup.com", "http://www.peerfoods.com", "http://www.belmontsausage.com", "http://www.hollypoultry.com", "http://www.andeannaturals.com", "http://www.viennabeef.com", "http://www.marcusfoodco.com", "http://www.selectonion.com", "http://www.aycofarms.com", "http://www.bassianfarms.com", "http://www.countryfreshinc.com", "http://www.qppinc.net", "http://www.harrisonspoultryfarm.com", "http://www.jonesdairyfarm.com", "http://www.bobak.com", "http://www.schaferfish.com", "http://www.tropicalfoods.com", "http://www.holmesfoods.com", "http://www.deenmeat.com", "http://www.oberto.com", "http://www.cibaomeat.com", "http://www.sewfriel.com", "http://www.babefarms.com", "http://www.comeausea.com", "http://www.doleandbailey.com", "http://www.casings.com", "http://www.mctdairies.com", "http://www.bsm.com", "http://www.sunriseproduce.com", "http://www.marchofarms.com", "http://www.berginfruit.com", "http://www.porkchops.com", "http://www.newstarfresh.com", "http://www.neesesausage.com", "http://www.sjsusa.com", "http://www.cappolafood.com", "http://www.daybreakfoods.com", "http://www.rosepacking.com", "http://www.belgioioso.com", "http://www.mullinscheese.com", "http://www.snopac.com", "http://www.sunvalleypecan.com", "http://www.progressiveproduce.com", "http://www.rembrandtfoods.com", "http://www.bcfoods.com", "http://www.kingnut.com", "http://www.dairyfoodusa.com", "http://www.randallfoods.com", "http://www.sunridgefarms.com", "http://www.goodheart.com", "http://www.northernproducts.com", "http://www.burnhamandmills.com", "http://www.marderbrands.com", "http://www.engelhartgourmet.com", "http://www.bazzininuts.com", "http://www.tulkoff.com", "http://www.curtispacking.com", "http://www.rumianocheese.com", "http://www.astrafoods.com", "http://www.blasersusa.com", "http://www.laurasleanbeef.com", "http://www.steubenfoods.com", "http://www.neiljonesfoodcompany.com", "http://www.sunnymorning.com", "http://www.bornstein.com", "http://www.mapleleaffarms.com", "http://www.catfish.net", "http://www.sbolive.com", "http://www.independentmeat.com", "http://www.suzannaskitchen.com", "http://www.routhpacking.com", "http://www.webstercitycustommeats.com", "http://www.cambridgepacking.com", "http://www.dartagnan.com", "http://www.agridairy.com", "http://www.isa-ak.com", "http://www.sunnyvalleysmokedmeats.com", "http://www.superiorfoods.com", "http://www.williams-sausage.com", "http://www.ingomarpacking.com", "http://www.thompack.com", "http://www.countrypleasin.com", "http://www.christopherranch.com", "http://www.fruit-dor.ca", "http://www.winonafoods.com", "http://www.fruvemex.com", "http://www.pintys.com", "http://www.bcwilliams.com", "http://www.southmill.com", "http://www.wilcoxfarms.com", "http://www.instantwhip.com", "http://www.cloverdalefoods.com", "http://www.dearbornbrand.com", "http://www.creamoland.com", "http://www.lcfoods.com", "http://www.superiorfoods.co", "http://www.danielefoods.com", "http://www.wawona.com", "http://www.livegourmet.com", "http://www.aedairy.com", "http://www.chefsrequested.com", "http://www.frontiermeats.com", "http://www.twincityfoods.com", "http://www.premiofoods.com", "http://www.turnerdairy.net", "http://www.clofinedairy.com", "http://www.moodydunbar.com", "http://www.radlo.com", "http://www.bothwellcheese.com", "http://www.holmessmokehouse.com", "http://www.cibaria-intl.com", "http://www.proportionfoods.com", "http://www.idahomilkproducts.com"]
	removed = []

	def parse_item(self, response):
		if  "bacon" in str(response.body).lower() or "bacons" in str(response.body).lower():
			# format: url -> domain
			url = urlparse(str(response.url)).netloc
			if url.startswith("www."):
				url = url[len("www."):]
			url = url[:find_nth(url,"/",3)]
			
			# remove url from allowed domains
			if url in self.removed:
				return
			try:
				self.allowed_domains.remove(url)
				self.removed.append(url)
			except Exception as e:
				raise e 

			# Refresh the regex cache for `allowed_domains`
			for mw in self.crawler.engine.scraper.spidermw.middlewares:
			    if isinstance(mw, scrapy.spidermiddlewares.offsite.OffsiteMiddleware):
			        mw.spider_opened(self)

			# look for bacon
			with open('output.txt', 'a') as f:
				f.write('Bacon found at: ' + str(response.url) + '\n\n')